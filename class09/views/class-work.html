<!DOCTYPE html>
<meta charset="utf-8">

<style>

.states {
  stroke: #fff;
  fill: none;
}

#popoverText { 
  position: absolute;     
  text-align: center;         
  padding: 2px;       
  font: 12px sans-serif;    
  background: #fff; 
  border: 0px;    
  border-radius: 8px;     
  pointer-events: none;
  opacity: 0;     
}

</style>

<body>
  <svg width="960" height="720"></svg>
  <div id='popoverText'> </div>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script>

const svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height");

const g = svg.append("g");

const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", zoomed);

svg.call(zoom);

let active = d3.select(null);

function zoomed() {
  g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
  // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
  g.attr("transform", d3.event.transform); // updated for d3 v4
}

function reset() {
  active.classed("active", false);
  active = d3.select(null);

  svg.transition()
      .duration(750)
      // .call( zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1) ); // not in d3 v4
      .call( zoom.transform, d3.zoomIdentity ); // updated for d3 v4
}

ready();

async function ready() {

  const guns = await d3.csv("guns-history.csv");
  const us = await d3.json("us.json");
  const topo = await d3.json("topo.json");


  const gunsLookup = {};
  const countyNameLookup = {};
  guns.forEach(d => {
    gunsLookup[d.FIPS] = +d.count3
    countyNameLookup[d.FIPS] = d.county
  })

const radiusScale = d3.scalePow()
    .exponent([.5])
    .domain([0, d3.max(guns, d => +d.count3)])
    .range([0, 50])

  const counties = topojson.feature(us, us.objects.counties),
        states = topojson.feature(us, us.objects.states);

console.log(guns)
  const path = d3.geoPath()
        .projection(d3.geoAlbersUsa()
        .fitSize([width, height], counties));

  const county = g.selectAll(".county")
      .data(counties.features)
    .enter().append("path")
      .attr("class", "county")
      .attr("d", path)
      .style("fill", d => gunsLookup[d.id] > 0 ? "darkgray" : "lightgray" )
      .on("mouseenter", function(d) {

        d3.select(this)
          .style("fill", "#000")

        d3.selectAll(".bubble")
          .filter(e => e == d)
          .style("stroke", "#000")

        d3.select("#popoverText")
          .style("opacity", 1)
          .style("top", `${d3.event.pageY}px`)
          .style("left", `${d3.event.pageX}px`)
          .text(countyNameLookup[d.id])
          // .style("fill", "#000")
      })
      .on("mouseleave", function(d) {

        d3.select(this)
          .style("fill", d => gunsLookup[d.id] > 0 ? "darkgray" : "lightgray" )
      
        d3.selectAll(".bubble")
          .filter(e => e == d)
          .style("stroke", "#fff")

        d3.select("#popoverText")
          .style("opacity", 0)
      })


  const state = g.selectAll(".state")
      .data(states.features)
    .enter().append("path")
      .attr("class", "state")
      .attr("d", path)
      .style("fill", "none")
      .style("stroke", "#fff")

  const bubble = g.selectAll(".bubble")
      .data(counties.features)
    .enter().append("circle")
      .attr("class", "bubble")
      .attr("transform", d => `translate(${path.centroid(d)})`)
      .style("fill", "red")
      // .attr("r", d => Math.sqrt(gunsLookup[d.id])/Math.PI)
      .attr("r", d => radiusScale(gunsLookup[d.id]))
      .style("fill-opacity", .5)
      .style("stroke", "#fff")
      .style("stroke-width", .5)
      .style("pointer-events", "none")

}

</script>
</body>
\




