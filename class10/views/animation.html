<!DOCTYPE html>
<meta charset="utf-8">

<style type="text/css">

  body {
    font-family: arial, sans;
    font-size: 14px;
  }

  .divisions {
    stroke: #000;
    stroke-width: .5;
  }

  #myTooltip {
    background-color: #fff;
    padding: 0px;
    margin: 5px;
    border: 1px solid #000;
    /*opacity: 0;*/
    position: absolute;
    top: 0px;
    left: 0px;
    pointer-events: none;
  }

  .tooltip-line {
    fill: none;
    stroke: #000;
  }

</style>

<body>
  <p id='loading'>It's Loading</p>
  <div id="chart-container"></div>
</body>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>

<script type="text/javascript">
  
const margin = {top: 5, right: 5, bottom: 5, left: 5};
const width = 900 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

const ttWidth = 300,
      ttHeight = 200,
      ttMargin = {top: 5, right: 15, bottom: 25, left: 25}

const myDiv = d3.select("body")
    .append("div")
    .attr("id", "myTooltip")
    .style("width", ttWidth + ttMargin.left + ttMargin.right + "px")
    .style("height", ttHeight + ttMargin.top + ttMargin.bottom + "px");

const ttSVG = myDiv.append("svg")
      .attr("width", ttWidth + ttMargin.left + ttMargin.right)
      .attr("height", ttHeight + ttMargin.top + ttMargin.bottom)
    .append("g")
      .attr("transform", `translate(${ttMargin.left}, ${ttMargin.top})`)

const xScale = d3.scalePoint()
    .range([0, ttWidth]);

const yScale = d3.scaleLinear()
   .range([ttHeight, 0]);

const lineGenerator = d3.line()
   .x(d => xScale(d.year))
   .y(d => yScale(d.val));

const ttLine = ttSVG.append("path")
    .attr("class", "tooltip-line");


// CHECKLIST FOR TOOLTIP
// Axes 
// Y axis -> Drought Index -> linearScale()
// X Axis -> Years -> scalePoint()
// lineGenerator = d3.line()
// call it all on to the page 

const colors = ['#c51b7d','#e9a3c9','#fde0ef','#f7f7f7','#e6f5d0','#a1d76a','#4d9221'];

const colorScale = d3.scaleThreshold()
        .domain([-4, -3, -2, 2, 3, 4])
        .range(colors);

ready();

async function ready() {

  const data = await d3.csv("data/tidy-drought-data.csv");
  const topojsonData = await d3.json("data/GIS.OFFICIAL_CLIM_DIVISIONS.json");

 const years = d3.set(data.map(d => +d.year)).values()
    .sort(d3.ascending);

  xScale.domain(years);
  yScale.domain(d3.extent(data, d => +d.val)).nice();

  ttSVG.append("g")
    .call(d3.axisLeft(yScale))

  ttSVG.append("g")
    .attr("transform", `translate(0,${ttHeight})`)
    .call(d3.axisBottom(xScale).tickValues([1895, 1920, 1955, 2013]))

  d3.select("#loading").remove()

  const climateDivisions = topojson.feature(topojsonData, topojsonData.objects.GIS)

  console.log(data, climateDivisions)

  const path = d3.geoPath()
      .projection(d3.geoAlbersUsa()
        .fitSize([width, height], climateDivisions))

 const svg  = d3.select("#chart-container")
    .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", `translate(${margin.left}, ${margin.top})`)


 const yearText = svg.append("text")
      .attr("y", 30)
      .style("font-size", 36)
      .text(years[0]);

  const dataLookup = {};
  data.filter(d => d.year == years[0])
  .forEach(d => {
    dataLookup[d.id] = d.val
  })

  const divisions = svg.selectAll(".divisions")
      .data(climateDivisions.features)
    .enter().append("path")
      .attr("class", "divisions")
      .attr("d", path)
      .style("fill", (d) => colorScale(dataLookup[d.properties.CLIMDIV]))
      .on("mouseenter", function(d) {
        d3.select(this).style("stroke-width", "4");

        myDiv.transition()
          .duration(100)
          .style("opacity", 1)
          .style("top", d3.event.pageY + "px")
          .style("left", d3.event.pageX + "px")

        ttLine
          .datum(data.filter(e => e.id == d.properties.CLIMDIV))
          .attr("d", lineGenerator);

      })      
      .on("mouseleave", function(d) {
        d3.select(this).style("stroke-width", ".5");

        myDiv.transition()
          .duration(100)
          .style("opacity", 0)

        ttLine
          .datum(data.filter(e => e.id == d.properties.CLIMDIV))
          .attr("d", lineGenerator);

      })


let index = 0;
let myTimer = d3.interval((elapsed) => {

  const dataLookup = {};
  data.filter(d => d.year == years[index])
  .forEach(d => {
    dataLookup[d.id] = d.val
  })

  yearText.text(years[index]);

  divisions
    .transition()
    .duration(450)
    .style("fill", (d) => colorScale(dataLookup[d.properties.CLIMDIV]))

  if((years.length - 1) == index) {
    myTimer.stop();
  }
  if(myRandoVariabile) {
    index += 1;
  }
}, 500)

  
  d3.select("body")
    .append("button")
    .datum(false)
    .text("Stop!")
    .on("click", function(d) {
      if(d == false) {
        myTimer.stop()
        d3.select(this).text("Start!")
        d3.select(this).datum(true)
      }  else {
        d3.select(this).datum(false)
        d3.select(this).text("Stop!")
        myTimer = d3.interval((elapsed) => {

          const dataLookup = {};
          data.filter(d => d.year == years[index])
          .forEach(d => {
            dataLookup[d.id] = d.val
          })

          yearText.text(years[index]);

          divisions
            .transition()
            .duration(450)
            .style("fill", (d) => colorScale(dataLookup[d.properties.CLIMDIV]))

          if((years.length - 1) == index) {
            myTimer.stop();
          }

          index += 1;
        }, 500)
      }
    })

}

</script>









