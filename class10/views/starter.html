<!DOCTYPE html>
<meta charset="utf-8">

<style type="text/css">

  body {
    font-family: arial, sans;
    font-size: 14px;
  }
  .divisions {
    stroke: #000;
    stroke-width: .5;
  }

</style>

<body>
  <p id='loading'>It's Loading</p>
  <div id="chart-container"></div>
</body>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>

<script type="text/javascript">
  
const margin = {top: 5, right: 5, bottom: 5, left: 5};
const width = 900 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

const colors = ['steelblue','#e9a3c9','#fde0ef','#f7f7f7','#e6f5d0','#a1d76a','#4d9221'];

const lineGenerator = d3.line()
  .x([d => xScale(d.year)])
  .y([d => yScale(d.val)]);

const colorScale = d3.scaleThreshold()
  .domain([-4, -3, -2, 2, 3, 4])
  .range(colors);

  ready();

async function ready() {
  // https://www.d3indepth.com/geographic/
  const data = await d3.csv('data/tidy-drought-data.csv');
  const topojsonData = await d3.json('data/GIS.OFFICIAL_CLIM_DIVISIONS.json');
  console.log('topojson ', topojson, 'topojson.feature ', topojson.feature)
  const climateDivisions = topojson.feature(topojsonData, topojsonData.objects.GIS)

  const years = d3.set(data.map(d => +d.year)).values()
    .sort(d3.ascending);

  const dataLookup = {};
  data.filter(d => d.year == years[0])
    .forEach(d => {
      // console.log('d id ', d.year, years[0], 'd.val', d.val)
      dataLookup[d.id] = d.val
    })
    

  console.log('datalookup ', dataLookup ,'climateDivisions ', climateDivisions)
  const path = d3.geoPath()
    .projection(d3.geoAlbersUsa()
      .fitSize([width, height], climateDivisions)
    )

  const svg = d3.select('#chart-container')
    .append('svg')
      .attr('width', width + margin.left + margin.right)
      .attr('height', height + margin.top + margin.bottom)
    .append('g')
      .attr("transform", `translate(${margin.left}, ${margin.top})`)
  
    // Tool tip
    var tt = d3.select("body")
    .append("div")
    .attr('class', 'tooltip')
    .style('pointer-events', 'none')
    .style('opacity', 0)
    .attr('text-anchor', 'middle')
    .attr('dominant-baseline', 'hanging') 

    function showToolTip(d) {
      // change circle outline to show hoverstate is active
      // d3.select(this)
      let distance;
      d.x > width/2 ? distance = -190 : distance = 50 
      tt.style('opacity', 0.9)
        .style('position', 'absolute')
        .style('left', d3.event.pageX + distance + "px")
        .style('top', d3.event.pageY + 100 + "px")
        .style('background', 'white')
        .style('border', '1px solid grey')
        .style('border-radius', '10px')
        .style('padding', '10px')
        .html(`<div><h6>State: ${d.properties.STATE}</h6><h6>,${d.properties.ST_ABBRV}</h6></div>`)
      }

  const divisions = svg.selectAll('.divisions')
      .data(climateDivisions.features)
    .enter().append('path')
      .attr('class', 'divisions')
      .attr('d', path)
      // .style('fill', (d) => colorScale(dataLookup[d.properties.CLIMDIV]))
      .attr('fill', (d,i) => {
        // console.log(d, i)
        return colorScale(dataLookup[d.properties.CLIMDIV]);
      })
    console.log('divisions ', divisions._groups)

    var nodes = divisions._groups;
    
    var nodes = d3.selectAll('path')
    divisions.on('click', function(d,i) {
      console.log('d,i ', d,i )
      d3.select(this)
        .attr('stroke', 'yellow')
        .attr('stroke-width', 3)
        .transition()
        .duration(1000)
        .attr('fill', 'yellow')
        showToolTip(d)
        // .transition()
        // .duration(2000)
        // .attr("transform", "translate("+ 200 + ", " + 10 + ")")
        
        
    })


    // d3.select(this).attr('stroke', 'black') 
    //       .attr('stroke-width', 3) 
    //   let distance;
    //   d.x > width/2 ? distance = -190 : distance = 50 
    //   tt.style('opacity', 0.9)
    //     .style('left', d3.event.pageX + distance + "px")
    //     .style('top', d3.event.pageY + 50 + "px")
    //     .html(`<h6>Rank: ${d.rank}</h6><h5>  ${(d.company)} </h5>   Years on List: ${d.yrs_on_list} <br> Industry: ${(d.industry)} <br> Revenue: $${d.revenue.toLocaleString()} <br> Growth: ${(d.growth.toLocaleString(undefined, {maximumFractionDigits: 0}))}% <br>From: ${(d.city)}, ${d.state_l} <br> founded: ${(d.founded)}<br> Workers: ${d.workers.toLocaleString()} <br>  `)
    //   }
    
    // d3.forceX(function(d,i ) {
    //   return 600;
    // })
      
    var simulate = function() {
      // nodes.forEach(function(node) {
        // console.log('node ', node )
        // node.x = node.x0;
        // node.y = node.y0;
        // node.r = radius(randomizer());
      // });
      
      // color.domain(d3.extent(divisions, d => d.r));

      // var links = d3.merge(neighbors.map(function(neighborSet, i) {
      //   return neighborSet.filter(j => nodes[j]).map(function(j) {
      //     return {source: i, target: j, distance: nodes[i].r + nodes[j].r + 3};
      //   });
      // }));
      // var simulation = d3.forceSimulation(divisions)
      // // .force('cx', d3.forceX(1500))
      // // .force('cy', d3.forceY(500))
      //   .force("cx", d3.forceX().x(d => width / 2).strength(0.02))
      //   .force("cy", d3.forceY().y(d => height / 2).strength(0.02))
      //   // .force("link", d3.forceLink(links).distance(d => d.distance))
      //   .force("x", d3.forceX().x(d => d.x).strength(0.1))
      //   .force("y", d3.forceY().y(d => d.y).strength(0.1))
      //   .force("collide", d3.forceCollide().strength(.1).radius(d => d.r + 3))


      // .stop();

      while (simulation.alpha() > 0.1) {
      simulation.tick();
      }
    }

    // simulate()
}

</script>

